<!DOCTYPE html>
<html
  lang="en"
  class="light-style layout-menu-fixed"
  dir="ltr"
  data-theme="theme-default"
  data-assets-path="../assets/"
  data-template="vertical-menu-template-free"
  xmlns:th="http://www.thymeleaf.org"
>
  <head th:replace="coach/layout/layout-head :: layout-head"></head>
  <body>
    <!-- Layout wrapper -->
    <div class="layout-wrapper layout-content-navbar">
      <div class="layout-container">
        <!-- Menu -->
        <div th:replace="coach/layout/layout-menu :: layout-menu"></div>

        <!-- / Menu -->

        <!-- Layout container -->
        <div class="layout-page">
          <!-- Navbar -->
          <div th:replace="coach/layout/layout-navbar :: layout-navbar"></div>

          <!-- / Navbar -->

          <!-- Content wrapper -->
          <div class="content-wrapper">
            <!-- Content -->
            <div class="container-xxl flex-grow-1 container-p-y">
              <h4 class="py-3 mb-4">
                <span class="text-muted fw-light">Quản lý /</span> Đặt lịch học
              </h4>

              <!-- Filters -->
              <div class="row mb-4">
                <div class="col-md-3">
                  <label for="statusFilter" class="form-label"
                    >Trạng thái</label
                  >
                  <select class="form-select" id="statusFilter">
                    <option value="">Tất cả</option>
                    <option value="PENDING">Chờ xác nhận</option>
                    <option value="CONFIRMED">Đã xác nhận</option>
                    <option value="REJECTED">Đã từ chối</option>
                    <option value="COMPLETED">Đã hoàn thành</option>
                    <option value="CANCELLED">Đã hủy</option>
                  </select>
                </div>
                <div class="col-md-3">
                  <label for="dateFilter" class="form-label">Ngày</label>
                  <input type="date" class="form-control" id="dateFilter" />
                </div>
                <div class="col-md-3">
                  <label class="form-label">&nbsp;</label>
                  <button
                    class="btn btn-primary d-block"
                    onclick="loadBookings()"
                  >
                    <i class="bx bx-search"></i> Lọc
                  </button>
                </div>
              </div>

              <!-- Bookings Table -->
              <div class="card">
                <div
                  class="card-header d-flex justify-content-between align-items-center"
                >
                  <h5 class="mb-0">Danh sách đặt lịch</h5>
                  <button class="btn btn-primary" onclick="refreshBookings()">
                    <i class="bx bx-refresh"></i> Làm mới
                  </button>
                </div>
                <div class="table-responsive text-nowrap">
                  <table class="table table-hover">
                    <thead>
                      <tr>
                        <th>Học viên</th>
                        <th>Ngày</th>
                        <th>Thời gian</th>
                        <th>Trạng thái</th>
                        <th>Thao tác</th>
                      </tr>
                    </thead>
                    <tbody id="bookingsTableBody">
                      <!-- Data will be loaded here -->
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
            <!-- / Content -->

            <!-- Footer -->
            <div th:replace="coach/layout/layout-footer :: layout-footer"></div>
            <!-- / Footer -->

            <div class="content-backdrop fade"></div>
          </div>
          <!-- Content wrapper -->
        </div>
        <!-- / Layout page -->
      </div>

      <!-- Overlay -->
      <div class="layout-overlay layout-menu-toggle"></div>
    </div>
    <!-- / Layout wrapper -->

    <!-- Booking Detail Modal -->
    <div class="modal fade" id="bookingDetailModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Chi tiết đặt lịch</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body" id="bookingDetailContent">
            <!-- Content will be loaded here -->
          </div>
          <div class="modal-footer" id="bookingDetailActions">
            <!-- Actions will be loaded here -->
          </div>
        </div>
      </div>
    </div>

    <!-- Core JS -->
    <script src="../assets/vendor/libs/jquery/jquery.js"></script>
    <script src="../assets/vendor/libs/popper/popper.js"></script>
    <script src="../assets/vendor/js/bootstrap.js"></script>
    <script src="../assets/vendor/libs/perfect-scrollbar/perfect-scrollbar.js"></script>
    <script src="../assets/vendor/js/menu.js"></script>

    <!-- Vendors JS -->
    <script src="../assets/vendor/libs/apex-charts/apexcharts.js"></script>

    <!-- Main JS -->
    <script src="../assets/js/main.js"></script>

    <!-- Page JS -->
    <script>
      // Load bookings when page loads
      document.addEventListener("DOMContentLoaded", function () {
        loadBookings();
      });

      // Load bookings from API
      function loadBookings() {
        const statusFilter = document.getElementById("statusFilter").value;
        const dateFilter = document.getElementById("dateFilter").value;

        // For demo, using coach ID 1 - in real app, get from session
        const coachId = 1;
        let url = `/api/bookings/coach/${coachId}`;

        // Add filters if provided
        const params = new URLSearchParams();
        if (statusFilter) params.append("status", statusFilter);
        if (dateFilter) params.append("date", dateFilter);
        if (params.toString()) url += "?" + params.toString();

        fetch(url)
          .then((response) => response.json())
          .then((bookings) => {
            displayBookings(bookings);
          })
          .catch((error) => {
            console.error("Error loading bookings:", error);
            // Show demo data for testing
            displayBookings(getDemoBookings());
          });
      }

      // Display bookings in table
      function displayBookings(bookings) {
        const tbody = document.getElementById("bookingsTableBody");
        tbody.innerHTML = "";

        bookings.forEach((booking) => {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>
              <div class="d-flex align-items-center">
                <div class="avatar avatar-sm me-3">
                  <span class="avatar-initial rounded-circle bg-label-primary">
                    ${booking.student?.name?.charAt(0) || "H"}
                  </span>
                </div>
                <div>
                  <h6 class="mb-0">${booking.student?.name || "Học viên"}</h6>
                  <small class="text-muted">${
                    booking.student?.email || ""
                  }</small>
                </div>
              </div>
            </td>
            <td>${formatDate(booking.bookingDate)}</td>
            <td>${booking.startTime} - ${booking.endTime}</td>
            <td>${getStatusBadge(booking.status)}</td>
            <td>
              <div class="dropdown">
                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                  Thao tác
                </button>
                <ul class="dropdown-menu">
                  <li><a class="dropdown-item" href="#" onclick="viewBookingDetail(${
                    booking.bookingId
                  })">
                    <i class="bx bx-show"></i> Xem chi tiết
                  </a></li>
                  ${
                    booking.status === "PENDING"
                      ? `
                    <li><a class="dropdown-item text-success" href="#" onclick="confirmBooking(${booking.bookingId})">
                      <i class="bx bx-check"></i> Xác nhận
                    </a></li>
                    <li><a class="dropdown-item text-danger" href="#" onclick="rejectBooking(${booking.bookingId})">
                      <i class="bx bx-x"></i> Từ chối
                    </a></li>
                  `
                      : ""
                  }
                  ${
                    booking.status === "CONFIRMED"
                      ? `
                    <li><a class="dropdown-item text-primary" href="#" onclick="completeBooking(${booking.bookingId})">
                      <i class="bx bx-check-double"></i> Hoàn thành
                    </a></li>
                    <li><a class="dropdown-item text-warning" href="#" onclick="cancelBooking(${booking.bookingId})">
                      <i class="bx bx-x-circle"></i> Hủy
                    </a></li>
                  `
                      : ""
                  }
                </ul>
              </div>
            </td>
          `;
          tbody.appendChild(row);
        });
      }

      // View booking detail
      function viewBookingDetail(bookingId) {
        fetch(`/api/bookings/${bookingId}`)
          .then((response) => response.json())
          .then((booking) => {
            const content = document.getElementById("bookingDetailContent");
            const actions = document.getElementById("bookingDetailActions");

            content.innerHTML = `
              <div class="row">
                <div class="col-md-6">
                  <h6>Thông tin học viên</h6>
                  <p><strong>Tên:</strong> ${booking.student?.name || "N/A"}</p>
                  <p><strong>Email:</strong> ${
                    booking.student?.email || "N/A"
                  }</p>
                  <p><strong>SĐT:</strong> ${
                    booking.student?.phone || "N/A"
                  }</p>
                </div>
                <div class="col-md-6">
                  <h6>Thông tin lịch học</h6>
                  <p><strong>Ngày:</strong> ${formatDate(
                    booking.bookingDate
                  )}</p>
                  <p><strong>Thời gian:</strong> ${booking.startTime} - ${
              booking.endTime
            }</p>
                  <p><strong>Trạng thái:</strong> ${getStatusText(
                    booking.status
                  )}</p>
                </div>
              </div>
            `;

            actions.innerHTML = `
              ${
                booking.status === "PENDING"
                  ? `
                <button type="button" class="btn btn-success" onclick="confirmBooking(${booking.bookingId})">
                  <i class="bx bx-check"></i> Xác nhận
                </button>
                <button type="button" class="btn btn-danger" onclick="rejectBooking(${booking.bookingId})">
                  <i class="bx bx-x"></i> Từ chối
                </button>
              `
                  : ""
              }
              ${
                booking.status === "CONFIRMED"
                  ? `
                <button type="button" class="btn btn-primary" onclick="completeBooking(${booking.bookingId})">
                  <i class="bx bx-check-double"></i> Hoàn thành
                </button>
                <button type="button" class="btn btn-warning" onclick="cancelBooking(${booking.bookingId})">
                  <i class="bx bx-x-circle"></i> Hủy
                </button>
              `
                  : ""
              }
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
            `;

            new bootstrap.Modal(
              document.getElementById("bookingDetailModal")
            ).show();
          })
          .catch((error) => {
            console.error("Error loading booking detail:", error);
            alert("Không thể tải thông tin chi tiết");
          });
      }

      // Booking actions
      function confirmBooking(bookingId) {
        if (confirm("Bạn có chắc muốn xác nhận lịch học này?")) {
          updateBookingStatus(bookingId, "confirm");
        }
      }

      function rejectBooking(bookingId) {
        if (confirm("Bạn có chắc muốn từ chối lịch học này?")) {
          updateBookingStatus(bookingId, "reject");
        }
      }

      function completeBooking(bookingId) {
        if (confirm("Bạn có chắc muốn đánh dấu hoàn thành lịch học này?")) {
          updateBookingStatus(bookingId, "complete");
        }
      }

      function cancelBooking(bookingId) {
        if (confirm("Bạn có chắc muốn hủy lịch học này?")) {
          updateBookingStatus(bookingId, "cancel");
        }
      }

      // Update booking status
      function updateBookingStatus(bookingId, action) {
        fetch(`/api/bookings/${bookingId}/${action}`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
        })
          .then((response) => response.json())
          .then((booking) => {
            // Close modal if open
            const modal = bootstrap.Modal.getInstance(
              document.getElementById("bookingDetailModal")
            );
            if (modal) modal.hide();

            // Reload bookings
            loadBookings();

            // Show success message
            showToast(
              "Thành công",
              `Đã ${getActionText(action)} lịch học`,
              "success"
            );
          })
          .catch((error) => {
            console.error("Error updating booking:", error);
            showToast("Lỗi", "Không thể cập nhật trạng thái", "error");
          });
      }

      // Utility functions
      function formatDate(dateString) {
        if (!dateString) return "N/A";
        const date = new Date(dateString);
        return date.toLocaleDateString("vi-VN");
      }

      function getStatusBadge(status) {
        const badges = {
          PENDING: '<span class="badge bg-label-warning">Chờ xác nhận</span>',
          CONFIRMED: '<span class="badge bg-label-success">Đã xác nhận</span>',
          REJECTED: '<span class="badge bg-label-danger">Đã từ chối</span>',
          COMPLETED:
            '<span class="badge bg-label-primary">Đã hoàn thành</span>',
          CANCELLED: '<span class="badge bg-label-secondary">Đã hủy</span>',
        };
        return (
          badges[status] ||
          '<span class="badge bg-label-secondary">Không xác định</span>'
        );
      }

      function getStatusText(status) {
        const texts = {
          PENDING: "Chờ xác nhận",
          CONFIRMED: "Đã xác nhận",
          REJECTED: "Đã từ chối",
          COMPLETED: "Đã hoàn thành",
          CANCELLED: "Đã hủy",
        };
        return texts[status] || "Không xác định";
      }

      function getActionText(action) {
        const texts = {
          confirm: "xác nhận",
          reject: "từ chối",
          complete: "hoàn thành",
          cancel: "hủy",
        };
        return texts[action] || action;
      }

      function refreshBookings() {
        loadBookings();
      }

      function showToast(title, message, type) {
        // Simple toast implementation - you can use a proper toast library
        alert(`${title}: ${message}`);
      }

      // Demo data for testing
      function getDemoBookings() {
        return [
          {
            bookingId: 1,
            student: { name: "Nguyễn Văn A", email: "nguyenvana@email.com" },
            bookingDate: "2024-06-10",
            startTime: "09:00",
            endTime: "10:00",
            status: "PENDING",
          },
          {
            bookingId: 2,
            student: { name: "Trần Thị B", email: "tranthib@email.com" },
            bookingDate: "2024-06-10",
            startTime: "14:00",
            endTime: "15:00",
            status: "CONFIRMED",
          },
          {
            bookingId: 3,
            student: { name: "Lê Văn C", email: "levanc@email.com" },
            bookingDate: "2024-06-11",
            startTime: "10:00",
            endTime: "11:00",
            status: "COMPLETED",
          },
        ];
      }
    </script>
  </body>
</html>
